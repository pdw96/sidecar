<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>이미지 업로드 & 리사이즈 데모</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 24px; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #555; background: #111; color: #fff; cursor: pointer; }
    #preview, #result { max-width: 480px; border: 1px solid #eee; border-radius: 8px; margin-top: 12px; }
    .muted { color: #666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>이미지 업로드 → 리사이즈 → 표시 V1</h1>
<div class="box">
    <input id="file" type="file" accept="image/*" />
    <button id="btnUpload">업로드</button>
    <div class="muted">업로드 후 리사이즈가 완료되면 아래에 결과가 표시됩니다.</div>
    <img id="preview" alt="preview" />
  </div>
<div class="box">
    <h3>리사이즈 결과</h3>
    <div id="status">대기 중…</div>
    <img id="result" alt="resized" />
  </div>
<script>
    const API_BASE = "<<<API_GATEWAY_BASE_URL>>>"; // 예: https://abc123.execute-api.ap-northeast-2.amazonaws.com
    const RESIZE_WIDTH = 800;
const $file = document.getElementById('file');
    const $btn = document.getElementById('btnUpload');
    const $preview = document.getElementById('preview');
    const $status = document.getElementById('status');
    const $result = document.getElementById('result');
$file.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) $preview.src = URL.createObjectURL(f);
    });
$btn.addEventListener('click', async () => {
      const f = $file.files?.[0];
      if (!f) return alert('파일을 선택하세요');
// 1) 업로드용 presigned URL
      const q = new URL(API_BASE + "/upload-url");
      q.searchParams.set("filename", f.name);
      q.searchParams.set("contentType", f.type || "application/octet-stream");
      const upRes = await fetch(q, { method: "GET" }).then(r => r.json());
      if (!upRes.uploadUrl) return alert("업로드 URL 생성 실패");
// 2) 직접 S3에 PUT
      await fetch(upRes.uploadUrl, { method: "PUT", headers: { "Content-Type": f.type }, body: f });
$status.textContent = "리사이즈 처리 중… (최대 수 초)";
      // 3) 폴링으로 리사이즈 결과 확인
      let tries = 0, maxTries = 30;
      let foundUrl = null;
      while (tries++ < maxTries) {
        const rq = new URL(API_BASE + "/resized-url");
        rq.searchParams.set("key", upRes.key);
        rq.searchParams.set("size", String(RESIZE_WIDTH));
        const r = await fetch(rq, { method: "GET" }).then(r => r.json());
        if (r.status === "ready" && r.url) { foundUrl = r.url; break; }
        await new Promise(res => setTimeout(res, 2000));
      }
      if (!foundUrl) {
        $status.textContent = "리사이즈 결과를 찾지 못했습니다. 잠시 후 새로고침 해보세요.";
        return;
      }
      $status.textContent = "완료!";
      $result.src = foundUrl; // presigned GET
    });
  </script>
</body>
</html>
